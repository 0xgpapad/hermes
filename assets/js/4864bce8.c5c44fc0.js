(self.webpackChunkhermes_website=self.webpackChunkhermes_website||[]).push([[195],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return p},kt:function(){return m}});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=a.createContext({}),d=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=d(e.components);return a.createElement(s.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=d(t),m=i,h=u["".concat(s,".").concat(m)]||u[m]||c[m]||o;return t?a.createElement(h,r(r({ref:n},p),{},{components:t})):a.createElement(h,r({ref:n},p))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var o=t.length,r=new Array(o);r[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var d=2;d<o;d++)r[d]=t[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},2477:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return r},metadata:function(){return l},toc:function(){return s},default:function(){return p}});var a=t(4034),i=t(9973),o=(t(7294),t(3905)),r={id:"vm",title:"VM Overview"},l={unversionedId:"vm",id:"vm",isDocsHomePage:!1,title:"VM Overview",description:"Value Representation",source:"@site/../doc/VM.md",sourceDirName:".",slug:"/vm",permalink:"/docs/vm",editUrl:"https://github.com/facebook/hermes/blob/master/website/../doc/VM.md",version:"current",lastUpdatedAt:1620718896,formattedLastUpdatedAt:"5/11/2021",frontMatter:{id:"vm",title:"VM Overview"},sidebar:"docs",previous:{title:"Design of the Optimizer",permalink:"/docs/optimizer"},next:{title:"The GenGC Garbage Collector",permalink:"/docs/gengc"}},s=[{value:"Value Representation",id:"value-representation",children:[{value:"Strings",id:"strings",children:[]}]},{value:"Runtime",id:"runtime",children:[{value:"Runtime Module",id:"runtime-module",children:[]},{value:"Runtime Identifiers",id:"runtime-identifiers",children:[]},{value:"Garbage Collection",id:"garbage-collection",children:[]}]},{value:"Object Model",id:"object-model",children:[{value:"Objects",id:"objects",children:[]},{value:"Arrays",id:"arrays",children:[]},{value:"Functions",id:"functions",children:[]},{value:"Boxed Primitives",id:"boxed-primitives",children:[]}]},{value:"REPL",id:"repl",children:[]}],d={toc:s};function p(e){var n=e.components,t=(0,i.Z)(e,["components"]);return(0,o.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"value-representation"},"Value Representation"),(0,o.kt)("p",null,"The VM uses a class called ",(0,o.kt)("inlineCode",{parentName:"p"},"HermesValue")," to encapsulate JS values efficiently,\npreserving their type while still allowing them to fit in a register.\nNaN-tagging is used to store different types of values;\nwe store values in the lower bits of a ",(0,o.kt)("inlineCode",{parentName:"p"},"uint64_t"),".\nThus, when the ",(0,o.kt)("inlineCode",{parentName:"p"},"uint64_t")," is interpreted as a ",(0,o.kt)("inlineCode",{parentName:"p"},"double"),",\ntagged ",(0,o.kt)("inlineCode",{parentName:"p"},"NaN")," values can hold non-",(0,o.kt)("inlineCode",{parentName:"p"},"double")," types."),(0,o.kt)("h3",{id:"strings"},"Strings"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"StringPrimitive")," is used to store immutable UTF16 encoded strings,\nand ",(0,o.kt)("inlineCode",{parentName:"p"},"StringPrimitive *")," can be stored in ",(0,o.kt)("inlineCode",{parentName:"p"},"HermesValue")," to make JS String values."),(0,o.kt)("p",null,"Internally, ",(0,o.kt)("inlineCode",{parentName:"p"},"StringPrimitive")," can be"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DynamicStringPrimitive")," (stored in the GC heap)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ExternalStringPrimitive")," (stored as a pointer outside the VM, such as into a bytecode file)")),(0,o.kt)("h2",{id:"runtime"},"Runtime"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"Runtime")," class is the primary driver of the VM.\nIt contains the current environment and heap, as well as the code to execute.\n",(0,o.kt)("inlineCode",{parentName:"p"},"Runtime")," is used to execute ",(0,o.kt)("inlineCode",{parentName:"p"},"RuntimeModule"),"s,\nwhich are constructed from ",(0,o.kt)("inlineCode",{parentName:"p"},"BytecodeModule"),"s using ",(0,o.kt)("inlineCode",{parentName:"p"},"Runtime::runModule()"),"."),(0,o.kt)("h3",{id:"runtime-module"},"Runtime Module"),(0,o.kt)("p",null,"A ",(0,o.kt)("inlineCode",{parentName:"p"},"RuntimeModule")," is the VM representation into a bytecode file.\n",(0,o.kt)("inlineCode",{parentName:"p"},"RuntimeModule"),"s are stored outside the GC heap and are constructed via ",(0,o.kt)("inlineCode",{parentName:"p"},"new"),"."),(0,o.kt)("p",null,"To allow for segmentation of bytecode files and ",(0,o.kt)("inlineCode",{parentName:"p"},"require"),"ing modules between\nseparate segments, we collect ",(0,o.kt)("inlineCode",{parentName:"p"},"RuntimeModule"),"s in a class called ",(0,o.kt)("inlineCode",{parentName:"p"},"Domain"),".\nYou may think of the ",(0,o.kt)("inlineCode",{parentName:"p"},"Domain")," as the collection of bytecode files which were\nall compiled in the same invocation of the compiler."),(0,o.kt)("p",null,"Every ",(0,o.kt)("inlineCode",{parentName:"p"},"JSFunction")," shares ownership of a ",(0,o.kt)("inlineCode",{parentName:"p"},"Domain"),", and the ",(0,o.kt)("inlineCode",{parentName:"p"},"Domain")," owns\nthe ",(0,o.kt)("inlineCode",{parentName:"p"},"RuntimeModule"),"s which provide those functions. In this way, when all\n",(0,o.kt)("inlineCode",{parentName:"p"},"JSFunction"),"s which require the files in a ",(0,o.kt)("inlineCode",{parentName:"p"},"Domain")," are collected,\nthe ",(0,o.kt)("inlineCode",{parentName:"p"},"Domain")," and the ",(0,o.kt)("inlineCode",{parentName:"p"},"RuntimeModule"),"s are also collected."),(0,o.kt)("h3",{id:"runtime-identifiers"},"Runtime Identifiers"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"Runtime")," contains an ",(0,o.kt)("inlineCode",{parentName:"p"},"IdentifierTable"),",\nwhich is used for getting unique IDs for strings.\nThe table is used to go from ",(0,o.kt)("inlineCode",{parentName:"p"},"StringPrimitive")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"SymbolID"),' and back.\nIt\'s prepopulated with some "predefined strings",\nthe set of strings that are required by built in functions,\nwhich can be seen in ',(0,o.kt)("inlineCode",{parentName:"p"},"PredefinedStrings.def"),"."),(0,o.kt)("h3",{id:"garbage-collection"},"Garbage Collection"),(0,o.kt)("p",null,"Currently, the VM uses ",(0,o.kt)("inlineCode",{parentName:"p"},"GenGCNC")," (generational non-contiguous GC).\nThe collector allows non-contiguous heap allocation.\nThis avoids preallocating too much memory, as well as returning memory to the OS.\nThe garbage collector is precise\n(it knows what ",(0,o.kt)("inlineCode",{parentName:"p"},"HermesValue"),"s are valid pointers to objects in the JS heap)."),(0,o.kt)("p",null,"See the documentation for the ",(0,o.kt)("a",{parentName:"p",href:"/docs/hades"},"Hades garbage collector")," for details\non how garbage collection works in Hermes. Hades is a garbage collector\nthat improves pause times dramatically over the older collector, called\n",(0,o.kt)("a",{parentName:"p",href:"/docs/gengc"},"GenGC"),". We recommend Hades for most applications."),(0,o.kt)("p",null,"The garbage collector moves objects to different place on the heap,\ninvalidating ",(0,o.kt)("inlineCode",{parentName:"p"},"HermesValue"),"s,\nso there are a couple classes which allow updating them automatically.\n",(0,o.kt)("inlineCode",{parentName:"p"},"Handle<>")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Handle<T>")," are garbage collector-aware handles;\nthey are moved if a collection occurs in between two successive accesses.\nSo, to ensure correctness in the VM,\nuse the handles instead of passing raw ",(0,o.kt)("inlineCode",{parentName:"p"},"HermesValue")," between functions."),(0,o.kt)("p",null,"A ",(0,o.kt)("inlineCode",{parentName:"p"},"GCScope")," is used to keep track of all the current ",(0,o.kt)("inlineCode",{parentName:"p"},"HermesValue")," handles.\nAny ",(0,o.kt)("inlineCode",{parentName:"p"},"GCScope")," must be constructed on the stack,\nwhence it tracks any scoped handles that are used until it falls out of scope.\nThe ",(0,o.kt)("inlineCode",{parentName:"p"},"GCScope")," allocates space in chunks,\nand when it is destroyed (falls out of scope) it frees any chunks it allocated.\nThe ",(0,o.kt)("inlineCode",{parentName:"p"},"GCScope")," is used to internally generate ",(0,o.kt)("inlineCode",{parentName:"p"},"PinnedHermesValue"),"s,\nwhich are then stored in ",(0,o.kt)("inlineCode",{parentName:"p"},"Handle<>")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Handle<T>"),"."),(0,o.kt)("p",null,"We also provide ",(0,o.kt)("inlineCode",{parentName:"p"},"PseudoHandle<T>")," classes which are explicitly ",(0,o.kt)("em",{parentName:"p"},"not")," handles.\nThese are used to be explicit about storage of raw pointers and ",(0,o.kt)("inlineCode",{parentName:"p"},"HermesValue"),".\n",(0,o.kt)("inlineCode",{parentName:"p"},"PseudoHandle")," should be used as an argument in place of a raw pointer to\nfunctions which may want to turn that argument into a ",(0,o.kt)("inlineCode",{parentName:"p"},"Handle"),",\nbut in which it's not necessary to ",(0,o.kt)("em",{parentName:"p"},"always")," incur the cost of handle allocation.\n",(0,o.kt)("inlineCode",{parentName:"p"},"PseudoHandle")," also does not have a copy constructor,\nand moving out of one invalidates it.\nThis prevents the reuse of ",(0,o.kt)("inlineCode",{parentName:"p"},"PseudoHandle")," after an allocating function call."),(0,o.kt)("h4",{id:"rules-for-using-handles"},"Rules for using handles"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"A function that can perform an allocation (even if it doesn't do it every\ntime) or calls a function that does, must accept and return only handles\n(for GC-managed objects). It must also take a ",(0,o.kt)("inlineCode",{parentName:"li"},"Runtime*")," as an argument."),(0,o.kt)("li",{parentName:"ol"},"A function that accepts or returns handles is allowed (and can be assumed\nto) allocate more handles, but the upper bound of allocated handles must be\nstatic."),(0,o.kt)("li",{parentName:"ol"},"The number of handles in a given GCScope should have a static upper limit.")),(0,o.kt)("p",null,"The motivation for these rules should be self-explanatory.  The practical\nimplication of rule 2 and 3 is that recursion and loops that allocate handles\nin every iteration must be treated specially.  In case of recursion a new\nGCScope should be defined in each recurrence (is that the correct term?).  In\ncase of a loop, there are a couple of possibilities:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"in loops that are expected to be low iteration and not performance critical,\na new GCScope can be defined in the body of the loop."),(0,o.kt)("li",{parentName:"ul"},"otherwise a GCScope::Marker should be used to flush the allocated handles of\nthe previous iteration."),(0,o.kt)("li",{parentName:"ul"},"mutable handles can be used to avoid allocating a new handle on every\niteration.")),(0,o.kt)("h2",{id:"object-model"},"Object Model"),(0,o.kt)("p",null,'Currently the object model is a VTable-based scheme,\nin which all possible JS values inherit from a base garbage collector VTable.\nThese are called "cells", and all the cells are defined in ',(0,o.kt)("inlineCode",{parentName:"p"},"CellKinds.def"),".\nObjects have a special ",(0,o.kt)("inlineCode",{parentName:"p"},"ObjectVTable"),", Callables have a ",(0,o.kt)("inlineCode",{parentName:"p"},"CallableVTable"),", etc."),(0,o.kt)("h3",{id:"objects"},"Objects"),(0,o.kt)("p",null,"Each JS object is represented by ",(0,o.kt)("inlineCode",{parentName:"p"},"Object")," (or a class derived from ",(0,o.kt)("inlineCode",{parentName:"p"},"Object"),').\nJS objects have a set of name/value pairs, and some optional "indexed storage".\nRead more about how ',(0,o.kt)("inlineCode",{parentName:"p"},"Object")," works in ",(0,o.kt)("inlineCode",{parentName:"p"},"ObjectModel.h"),".\nThe Runtime contains a global object which is used to store in global scope."),(0,o.kt)("h3",{id:"arrays"},"Arrays"),(0,o.kt)("p",null,"Arrays, the ",(0,o.kt)("inlineCode",{parentName:"p"},"arguments")," object, etc. inherit from Object directly,\nbut simply provide their own implementations of ",(0,o.kt)("inlineCode",{parentName:"p"},"*OwnIndexed")," using the VTable."),(0,o.kt)("h3",{id:"functions"},"Functions"),(0,o.kt)("p",null,"Functions and native functions inherit from ",(0,o.kt)("inlineCode",{parentName:"p"},"Callable"),".\nThis allows them to call ",(0,o.kt)("inlineCode",{parentName:"p"},"executeCall*")," to run functions using the internal API."),(0,o.kt)("h3",{id:"boxed-primitives"},"Boxed Primitives"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"PrimitiveBox")," class is used to contain Booleans, Strings, and Numbers,\nwhen they are constructed using their respective JS constructors.\n",(0,o.kt)("inlineCode",{parentName:"p"},"JSString")," is a ",(0,o.kt)("inlineCode",{parentName:"p"},"PrimitiveBox")," that is used for ",(0,o.kt)("inlineCode",{parentName:"p"},"String")," objects, etc."),(0,o.kt)("h2",{id:"repl"},"REPL"),(0,o.kt)("p",null,"The HermesVM provides a REPL in ",(0,o.kt)("inlineCode",{parentName:"p"},"bin/hermes"),",\nwhich calls through to the ",(0,o.kt)("inlineCode",{parentName:"p"},"eval()")," global function in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Runtime"),"."))}p.isMDXComponent=!0}}]);